#!/usr/bin/env node

/* eslint-disable no-console */

/**
 * This script extracts stablecoin addresses from @juicedollar/jusd package
 * and generates a TypeScript file with the addresses.
 *
 * Used by GitHub Action to keep addresses in sync automatically.
 *
 * Usage: node scripts/sync-stablecoin-addresses.js
 */

const fs = require('fs');
const path = require('path');

const OUTPUT_FILE = path.join(__dirname, '../lib/token/stablecoin-addresses.generated.ts');
const ZERO_ADDRESS = '0x0000000000000000000000000000000000000000';

// Stablecoin token keys to extract
const STABLECOIN_KEYS = [ 'juiceDollar', 'startUSD', 'USDC', 'USDT', 'CTUSD' ];

function extractAddresses() {
  let ADDRESS;
  try {
    const jusd = require('@juicedollar/jusd');
    ADDRESS = jusd.ADDRESS;
  } catch (error) {
    console.error('Error: @juicedollar/jusd package not found.');
    console.error('Install it first: npm install @juicedollar/jusd');
    process.exit(1);
  }

  const result = {};

  for (const [ chainId, addresses ] of Object.entries(ADDRESS)) {
    const stablecoins = [];

    for (const key of STABLECOIN_KEYS) {
      const addr = addresses[key];
      if (addr && addr !== ZERO_ADDRESS) {
        stablecoins.push(addr.toLowerCase());
      }
    }

    if (stablecoins.length > 0) {
      result[chainId] = stablecoins;
    }
  }

  return result;
}

function generateTypeScript(addresses) {
  const timestamp = new Date().toISOString();

  // Format addresses object with proper indentation and single quotes
  const formattedAddresses = Object.entries(addresses)
    .map(([ chainId, addrs ]) => {
      const addrLines = addrs.map((addr) => `    '${ addr }',`).join('\n');
      return `  '${ chainId }': [\n${ addrLines }\n  ],`;
    })
    .join('\n');

  return `// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// Generated by: scripts/sync-stablecoin-addresses.js
// Last updated: ${ timestamp }
// Source: @juicedollar/jusd package

/**
 * Stablecoin addresses by chain ID.
 * These tokens will display a fixed price of $1.00.
 */
export const STABLECOIN_ADDRESSES: Record<string, ReadonlyArray<string>> = {
${ formattedAddresses }
};
`;
}

function main() {
  console.log('Extracting stablecoin addresses from @juicedollar/jusd...');

  const addresses = extractAddresses();
  const content = generateTypeScript(addresses);

  // Check if file exists and content is different
  let hasChanges = true;
  if (fs.existsSync(OUTPUT_FILE)) {
    const existingContent = fs.readFileSync(OUTPUT_FILE, 'utf-8');
    // Compare without timestamp line
    const normalize = (s) => s.replace(/Last updated:.*\n/, '');
    hasChanges = normalize(existingContent) !== normalize(content);
  }

  if (hasChanges) {
    fs.writeFileSync(OUTPUT_FILE, content);
    console.log(`Updated: ${ OUTPUT_FILE }`);
    console.log('Addresses:', JSON.stringify(addresses, null, 2));
    process.exit(0);
  } else {
    console.log('No changes detected.');
    process.exit(0);
  }
}

main();
